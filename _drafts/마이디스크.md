### 파일 종류 정의:

1. 사전 공개 파일:
    - 관리자 최초 업로드 자료 + 유저 공개 파일
    - 모든 사용자가 READ 가능하고, 모든 자료 수집(제안서)의 RAG에 포함됩니다.
2. 공개 파일:
    - 유저가 로컬에서부터 업로드한 자료
    - 사전 공개 파일로 추가되어 모두에게 공개됩니다.
3. 비공개 파일:
    - 유저가 로컬에서부터 업로드한 자료
    - 공개 에이전트 선택시엔 사용되지 않습니다.

### 파일 저장 및 관리 구조

1. **공개 폴더와 개인 폴더의 분리**:
    - **사전 공개 폴더**:
        - 모든 사용자가 접근할 수 있는 폴더로, 사전 공개 파일과 사용자의 공개 파일이 저장됩니다.
        - 어떤 사용자든지 읽을 수 있으며, 모든 자료 수집(제안서)의 RAG에 포함됩니다.
    - **개인 폴더 (공개, 비공개)**:
        - 각 사용자별로 할당된 폴더로, 사용자가 업로드한 공개 파일과 비공개 파일을 별도로 저장합니다.
        - 각 사용자만이 접근할 수 있습니다.
2. **파일 메타데이터 관리**:
    - 각 파일에는 타입(사전 공개, 공개, 비공개), 업로더, 업로드 날짜, 파일 크기, 원본 파일명 등의 메타데이터를 포함합니다.
    - 공개 폴더에 업로드된 파일은 자동으로 모든 사용자가 접근할 수 있는 권한을 부여받으며, 개인 폴더에 업로드된 파일은 해당 사용자만 접근할 수 있는 권한 설정을 합니다.

### file 테이블

|컬럼명|데이터 타입|설명|
|---|---|---|
|file_idx|int unsigned|파일 인덱스, 기본 키, 자동 증가|
|prp_idx|int unsigned|제안서 인덱스, 외래 키|
|writer_idx|int unsigned|업로드 사용자 인덱스|
|extension|varchar(8)|파일 확장자|
|file_dir|varchar(255)|파일 저장 경로|
|file_name|varchar(64)|저장된 파일명|
|org_filename|varchar(256)|원본 파일명|
|file_type|varchar(10)|파일 타입 (private / public)|
|file_size|int unsigned|파일 크기 (byte)|
|reg_dt|datetime|등록 일자|

3. **사용자 인터페이스**:
    - 사용자는 자신의 마이디스크 내 파일을 쉽게 볼 수 있도록 파일 관리 시스템에 접근. 여기서는 자신이 업로드한 파일을 포함하여, 공개 폴더의 파일도 확인할 수 있습니다.

### 전체 공개 데이터 목록

![https://i.imgur.com/apezG6D.png](https://i.imgur.com/apezG6D.png)

### 사용자 파일 추가 flow

![https://i.imgur.com/gCc96tr.png](https://i.imgur.com/gCc96tr.png)

4. **중복 파일 관리**:
    - 파일 업로드 시 시스템은 파일의 해시값을 계산하여 데이터베이스에 저장된 해시값과 비교해 중복 파일을 체크
    - 이미 존재하는 파일과 동일한 해시값을 가진 파일이 업로드되면, 실제 파일을 중복 저장하지 않고 기존 파일의 위치를 참조

### 기능 & API

### 1. 파일 업로드 및 관리

- **파일 업로드 API**: 사용자가 파일을 시스템에 업로드할 수 있게 하는 API. 파일 메타데이터를 포함하여 업로드 처리를 진행
- **파일 저장**: 파일이 저장될 경로를 관리하고, 파일 타입에 따라 적절한 폴더(공개 폴더 또는 개인 폴더)에 저장
- **파일 메타데이터 관리**: 파일의 타입, 업로드 날짜, 업로더 정보, 파일 크기 등의 파일 정보를 데이터베이스에 저장

### 2. 파일 접근 및 권한 관리

- 파일의 공개 여부에 따라 접근 권한을 설정
- 공개 파일은 모든 사용자가 접근할 수 있고, 비공개 파일은 업로더만 접근할 수 있어야 함.

### 3. 중복 파일 관리

- **중복 검사 로직**: 업로드된 파일의 해시값을 계산하고, 이를 기존에 저장된 파일의 해시값과 비교하여 중복을 확인
- **파일 참조 관리**: 중복 파일이 발견되면 새로운 파일을 저장하지 않고 기존 파일의 참조를 사용

### 4. 파일 벡터화 및 검색

- **벡터DB 동기화**:
    - 공개 폴더의 파일을 주기적으로 스캔
    - 중복 파일 검사
    - embedding하여 벡터 DB에 업로드
- **벡터 데이터베이스 연동**: 파일 내용을 벡터 형태로 변환하고, 이를 벡터 데이터베이스에 저장

### 5. 사용자 인터페이스

- 사용자: 사용자 PC로부터 파일 업로드, 업로드된 파일 목록 확인, 삭제, 다운로드
- **공개 파일 목록 조회**: 공개 파일 목록을 조회, 다운로드

### 파일 관리 시스템 API 명세서

|기능|엔드포인트|방법|매개변수|설명|
|---|---|---|---|---|
|파일 업로드|/upload|POST|file: 파일 데이터, file_type: 'public'/'private'|사용자가 파일을 시스템에 업로드하고 메타데이터 포함 업로드 처리|
|파일 메타데이터 저장|/file/metadata|POST|file_name, org_filename, file_size, file_type, file_dir, reg_dt|업로드 후 파일 메타데이터를 DB에 저장|
|중복 파일 검사|/file/duplicate-check|POST|file_hash: 파일의 해시 값|업로드된 파일의 해시값으로 중복 확인|
|파일 참조 관리|/file/manage-ref|POST|file_hash: 파일의 해시 값|중복 파일 존재 시 기존 파일 참조 사용|
|벡터 데이터베이스 동기화|/vector/synchronize|POST|None|공개 폴더의 파일을 벡터 데이터베이스에 동기화|
|파일 목록 조회|/files|GET|user_id (선택적): 사용자 ID|사용자의 파일 목록 조회|
|공개 파일 목록 조회|/files/public|GET|None|모든 사용자가 접근 가능한 공개 파일 목록 조회|
|파일 삭제|/file/delete|DELETE|file_idx: 파일 인덱스|지정된 파일 삭제|
|파일 다운로드|/file/download|GET|file_idx: 파일 인덱스|지정된 파일을 다운로드|
|파일 상세 정보 조회|/file/details|GET|file_idx: 파일 인덱스|특정 파일의 상세 메타데이터 조회|
